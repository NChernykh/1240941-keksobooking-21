(()=>{"use strict";window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t())},isMouseEvent:(e,t)=>{0===e.button&&(e.preventDefault(),t())},fieldsOff:e=>{e.forEach((e=>{e.setAttribute("disabled","true")}))},fieldsOn:e=>{e.forEach((e=>{e.removeAttribute("disabled")}))},removeItem:e=>{e&&e.remove()}},window.debounce=(e,t)=>{let o=null;return(...n)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...n)}),t)}},window.backend={sendRequest:(e,t,o,n,r)=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{let e;switch(s.status){case 200:n(s.response);break;case 404:e=`ошибка ${s.status} ${s.statusText} данные не найдены`;break;default:e=`Cтатус ответа: ${s.status} ${s.statusText}`}e&&r(e)})),s.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за ${s.timeout} мс`)})),s.timeout=1e4,s.open(e,t),s.send(o)}},(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t=["gif","jpg","jpeg","png"],o={1:{key:[1],message:"1 комната для 1-го гостя"},2:{key:[1,2],message:"2 комнаты для 1-го или 2-х гостей"},3:{key:[1,2,3],message:"3 комнаты для 1-го, 2-х или 3-х гостей"},100:{key:[0],message:"100 комнат не для гостей"}},n=document.querySelector(".ad-form"),r=n.querySelector("#avatar"),s=n.querySelector(".ad-form-header__preview img"),d=n.querySelector("#images"),a=n.querySelector(".ad-form__photo"),c=s.src,i=n.querySelectorAll("fieldset"),u=n.querySelector("#room_number"),l=n.querySelector("#capacity"),p=n.querySelector("#type"),m=n.querySelector("#price"),f=n.querySelector("#timein"),v=n.querySelector("#timeout"),w=e=>{const o=e.files[0],n=o.name.toLowerCase();if(t.some((e=>n.endsWith(e)))){const t=new FileReader;e===r?t.addEventListener("load",(()=>{s.src=t.result})):e===d&&t.addEventListener("load",(()=>{a.style.backgroundSize="contain",a.style.backgroundImage=`url(${t.result})`})),t.readAsDataURL(o)}};r.addEventListener("change",(()=>{s.src=c,w(r)})),d.addEventListener("change",(()=>{a.style.backgroundImage="",w(d)}));const y=()=>{const e=u.value,t=l.value,n=o[e];+t>n.key.length||0==+t&&+e<100||100==+e&&1==+t||1==+e&&0==+t?l.setCustomValidity(n.message):l.setCustomValidity(""),l.reportValidity()},E=()=>{m.placeholder=e[p.value],m.min=e[p.value]},_=e=>{f.value=e.target.value,v.value=e.target.value};u.addEventListener("change",y),l.addEventListener("change",y),p.addEventListener("change",E),m.addEventListener("change",E),f.addEventListener("change",_),v.addEventListener("change",_),window.form={disable:()=>{n.classList.add("ad-form--disabled"),window.util.fieldsOff(i),s.src=c,a.style.backgroundImage=""},active:()=>{n.classList.remove("ad-form--disabled"),window.util.fieldsOn(i)},onPriceChange:E}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),o=document.querySelector(".map__filters-container"),n=document.querySelector("#card").content.querySelector(".map__card").cloneNode(!0),r=()=>{const e=document.querySelector(".map__card");window.util.removeItem(e)},s=e=>{window.util.isEscEvent(e,d)},d=()=>{const e=document.querySelector(".map__card");window.util.removeItem(e),document.removeEventListener("keydown",s)};window.card={onCardClose:d,onCardOpen:a=>{var c;r(),c=a,n.querySelector(".popup__title").textContent=c.offer.title,n.querySelector(".popup__text--address").textContent=c.offer.address,n.querySelector(".popup__text--price").textContent=c.offer.price+" ₽/ночь",n.querySelector(".popup__type").textContent=e[c.offer.type],n.querySelector(".popup__text--capacity").textContent=`${c.offer.rooms} комнаты для ${c.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${c.offer.checkin}, выезд до ${c.offer.checkout}`,n.querySelector(".popup__description").textContent=c.offer.description,n.querySelector(".popup__avatar").src=c.author.avatar,(e=>{const t=n.querySelector(".popup__features"),o=n.querySelectorAll(".popup__feature");for(let e of o)window.util.removeItem(e);e.forEach((e=>{const o=document.createElement("li");o.className="popup__feature popup__feature--"+e,t.appendChild(o)}))})(c.offer.features),(e=>{const t=n.querySelector(".popup__photos"),o=t.querySelectorAll(".popup__photo");for(let e of o)window.util.removeItem(e);e.forEach((e=>{const o=document.createElement("img");o.className="popup__photo",o.src=e,o.width=45,o.height=40,t.appendChild(o)}))})(c.offer.photos),t.insertBefore(n,o),document.addEventListener("keydown",s),t.querySelector(".popup__close").addEventListener("click",d)},remove:r}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin");window.pins={render:o=>{const n=document.createDocumentFragment();o.forEach((e=>{n.appendChild((e=>{const o=t.cloneNode(!0),n=o.querySelector("img");o.style.left=e.location.x-25+"px",o.style.top=e.location.y-70+"px",n.src=e.author.avatar,n.alt=e.offer.title;const r=()=>{window.card.onCardOpen(e)};return o.addEventListener("click",(()=>{window.card.onCardOpen(e)})),o.addEventListener("keydown",(e=>{window.util.isEnterEvent(e,r)})),o})(e))})),e.appendChild(n)},remove:()=>{const e=document.querySelector(".map__pin:not(.map__pin--main)"),t=document.querySelectorAll(".map__pin:not(.map__pin--main)");e&&t.forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector("#address"),n={top:43,right:e.offsetWidth-32.5,left:-32.5,bottom:543},r=()=>{const n=Math.round(t.offsetLeft+32.5),r=Math.round(t.offsetTop+32.5),s=Math.round(r+32.5+22);o.value=e.classList.contains("map--faded")?`${n-1}, ${r-1}`:`${n-1}, ${s-1}`};t.addEventListener("mousedown",(e=>{e.preventDefault();let o={x:e.clientX,y:e.clientY};const s=e=>{e.preventDefault();const s=o.x-e.clientX,d=o.y-e.clientY;o={x:e.clientX,y:e.clientY};const a={x:t.offsetLeft-s,y:t.offsetTop-d};var c;(c=a).x>=n.right&&(c.x=n.right),c.x<=n.left&&(c.x=n.left),c.y>=n.bottom&&(c.y=n.bottom),c.y<=n.top&&(c.y=n.top),t.style.top=a.y+"px",t.style.left=a.x+"px",r()},d=e=>{e.preventDefault(),r(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",d)})),window.mainPin={setCoords:r}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),s=e.querySelector("#housing-features"),d={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}};let a=[];const c=e=>(a=e,e.filter((e=>{let a="any"===t.value||e.offer.type===t.value,c="any"===n.value||e.offer.rooms===+n.value,i="any"===r.value||e.offer.guests===+r.value,u="any"===o.value||e.offer.price>=d[o.value].start&&e.offer.price<d[o.value].end,l=Array.from(s.querySelectorAll("input:checked")).map((function(e){return e.value})).every((t=>e.offer.features.includes(t)));return a&&c&&i&&u&&l})).slice(0,5)),i=window.debounce((()=>{window.pins.remove(),window.card.remove(),window.pins.render(c(a))}),500);e.addEventListener("change",i),window.filters={renderData:c}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__button");window.popup={getSuccess:()=>{document.body.appendChild(e);const t=()=>{e.remove(),document.removeEventListener("click",o),document.removeEventListener("keydown",n)},o=()=>{t()},n=e=>{window.util.isEscEvent(e,t)};document.addEventListener("click",o),document.addEventListener("keydown",n)},getError:e=>{t.querySelector(".error__message").textContent=e,document.body.appendChild(t);const n=e=>{window.util.isEscEvent(e,r)};o.addEventListener("click",(()=>{r()})),document.addEventListener("keydown",n);const r=()=>{t.remove(),document.removeEventListener("keydown",n)}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o=document.querySelector(".map"),n=o.querySelector(".map__pin--main"),r=o.querySelectorAll("select, fieldset"),s=document.querySelector(".ad-form"),d=s.querySelector(".ad-form__reset"),a=e=>{window.util.isEnterEvent(e,p)},c=e=>{window.util.isMouseEvent(e,p)},i=()=>{m()};s.addEventListener("submit",(e=>{e.preventDefault();let o=new FormData(s);window.backend.sendRequest("POST",t,o,window.popup.getSuccess,window.popup.getError),m()}));const u=e=>{window.util.fieldsOn(r);const t=window.filters.renderData(e);window.pins.render(t)},l=e=>{window.popup.getError(e)},p=()=>{o.classList.remove("map--faded"),window.mainPin.setCoords(),window.form.active(),window.backend.sendRequest("GET",e,"",u,l),n.removeEventListener("keydown",a),n.removeEventListener("click",c),d.addEventListener("click",i)},m=()=>{window.util.fieldsOff(r),o.classList.add("map--faded"),s.reset(),window.form.onPriceChange(),window.form.disable(),n.style.left="570px",n.style.top="375px",window.mainPin.setCoords(),window.pins.remove(),window.card.remove(),d.removeEventListener("click",i),n.addEventListener("mousedown",c),n.addEventListener("keydown",a)};n.addEventListener("mousedown",c),n.addEventListener("keydown",a),window.map={deactivatePage:m}})(),window.map.deactivatePage()})();